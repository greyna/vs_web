<html>
<head>
	<meta charset="utf-8">
	<script src="admin/jquery.js"></script>
	<script src="admin/handlebars-v1.3.0.js"></script>
    <script src="admin/menu_prototype.js"></script>
    <script src="admin/item_prototype.js"></script>
	<script src="admin/template.js"></script>
	<script src="admin/page.js"></script>
    <script src="admin/util.js"></script>
<script>
function EditPage() {
	var that = this;
	
	that.template = new Template();
	that.menu = new Menu();
	that.page = new Page();

	that.getTemplateAndMenuThenRender = function() {
		that.template.type = that.page.templatetype;

		that.menu.lang = that.page.lang;
		
		getPublishedComponent(that.template, function() {
			getPublishedComponent(that.menu, function() {
				that.renderPage(true);
			}, function(){});
		}, function(){});
	}

	that.renderPage = function( isEditable ) {
		var context = new Object();

		context.menu = that.menu;
		context.page = that.page;
		if (isEditable === true) {
			context.editable = 'id="editable" contenteditable="true"';
		}

		var templatePage = Handlebars.compile(that.template.html);
		var html = templatePage(context);

		//on génère le document avec la page obtenue

		if (isEditable === true) {
			document.write(html);
			document.close();
			that.renderUI();
		}

		// le html retourné correspond au rendu d'une page sans le #editable
		return html;
	};

	that.renderUI = function() {
		jq('body').append('<br/><button id="save" type="button" class="btn btn-default navbar-btn btn_insertion_bd">Enregistrer</button>');
		jq('body').append('<button id="deploy" type="button" class="btn btn-default navbar-btn btn_insertion_bd">Déployer sur le serveur</button>');
		jq('body').append('<a target="_blank" href="../'+that.page.name+'.html'+'">Voir la page réelle</button>');

		jq("#save").click(function (e) {
			that.savePage();
		});
		jq("#deploy").click(function (e) {
			that.page.published = true;
			that.savePage();
			deployHtml(that.renderPage(false), that.page.name+".html");
		});

		jq('body').append('<script src="admin/edit/ckeditor.js" />');
	}

	that.savePage = function() {
		that.page.body = jq('#editable').html();
		saveComponent(that.page, function(){});
	}

	that.init = function() {
		// editPage.html?page=key
		var params = getSearchParameters();
		that.page.key = params.page;


		getComponent(that.page, function() {
			that.getTemplateAndMenuThenRender();
		}, function(){});
	}
}

var jq = jQuery.noConflict();
var editPage = new EditPage();
editPage.init();

</script>
</head>
<body>
</body>
</html>